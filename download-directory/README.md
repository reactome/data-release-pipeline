<h2>Download Directory</h2>

The Download Directory step generates a number of files that can be downloaded from Reactome's <a href="https://reactome.org/download-data">download page</a>. It also generates an archive file during the <b>CreateReleaseTarball</b> step that acts as a snapshot of the <a href="https://github.com/reactome/Release">Release repository</a> and some services on the release server. This module has been rewritten from Perl to Java. 
<br><br>The steps of Download Directory and files produced are:

- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#databasedumps">DatabaseDumps</a>: `gk_stable_ids.sql`, `gk_current.sql`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#biopax">BioPAX</a>: `biopax2.zip`, `biopax2_validator.zip`, `biopax.zip`, `biopax_validator.zip`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#gseaoutput">GSEAOutput</a>: `ReactomePathways.gmt.zip`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#fetchtestreactomeontologyfiles">FetchTestReactomeOntologyFiles</a>: `reactome_data_model.pprj`, `reactome_data_model.pont`, `reactome_data_model.pins`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#pathwaysummationmappingfile">PathwaySummationMappingFile</a>: `pathway2summation.txt`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#mapoldstableids">MapOldStableIds</a>: `reactome_stable_ids.txt`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#generategoannotationfile">GenerateGOAnnotationFile</a>: `gene_association.reactome`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#models2pathways.tsv">models2pathways.tsv</a>: `models2pathways.tsv`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#createreactome2biosystems">CreateReactome2BioSystems</a>: `ReactomeToBioSystems.zip`

Files no longer generated by download directory include:
-  All `SBML` and `SBGN` files (generated elsewhere)
- `diagrams.pdf.zip` and `diagrams.png.zip`
- `curated_complex.txt` and `curated_complexes.stid.txt`
- `compiled_pathway_images` files
- `st_id_2_uniprot.txt`
- `TheReactomeBook.pdf.zip` and `TheReactomeBook.rtf.zip`
- `reactome.tar.gz`

<h3> Preparing and running Download Directory</h3>

To run the Download Directory step, a few things need to be taken into account.

<b> Local installation of the Pathway-Exchange dependancy</b>

Download Directory depends on a local installation of <a href="https://github.com/reactome/Pathway-Exchange">Pathway-Exchange</a>. This requires generating a new <b>ant</b> build using <a href="https://github.com/reactome/Pathway-Exchange/blob/master/ant/PathwayExchangeJar.xml">PathwayExchangeJar.xml</a>. It can be built using most IDEs (such as Eclipse or IntelliJ) or using the following command:<br>
`ant -buildfile ant/PathwayExchangeJar.xml`

This makes sure that the <a href="https://reactome.org/content/schema/">Data Model</a> is up to date. If not updated, an unexpected data structure could cause the <b>BioPAX</b>, <b>GSEAOutput</b> or <b>CreateReactome2BioSystems</b> steps to fail. 

Once the jar file has been built, it should appear above the `Pathway-Exchange` directory in the `RESTfulAPI/web/WEB-INF/lib/` folder. The jar file next needs to be installed locally in accordance with the <b>POM</b> file in the Download Directory repo.
<br><br>
Here is a sample snippet from the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/pom.xml">pom.xml</a> file in Download Directory that contains the <b>Pathway-Exchange</b> information we care about:

```
<!-- Locally installed pathway exchange jar -->
  <dependency>
    <groupId>org.reactome.pathway-exchange</groupId>
    <artifactId>pathwayExchange</artifactId>
    <version>1.0.1</version>
  </dependency>
```

Based on the above information POM file snippet, to locally install the `pathwayExchange.jar` we would use the following command:<br><br>
`mvn install:install-file -Dfile=pathwayExchange.jar -DgroupId=org.reactome.pathway-exchange -DartifactId=pathwayExchange -Dversion=1.0.1 -Dpackaging=jar`

  - Make sure the <i>groupId</i>, <i>artifactId</i>, and <i>version</i> arguments match the same fields in the POM

If the build was successful, we have successfully installed an up-to-date Pathway-Exchange jar file that will be used during Download Directory.

<b> Setting config.properties </b>

Next the `config.properties` file must be set or updated in the `src/main/resources/` folder. Below is a sample file:
```
## Sample config.properties file for Download Directory
username=mySQLUsername
password=mySQLPassword
database=release_current
host=localhost
port=3306
release=releaseNumber
## Filepaths important to the Download Directory step
absoluteReleaseDirectoryPath=/usr/local/gkb/scripts/release/
releaseDownloadDirectoryPath=/usr/local/gkb/scripts/release/download_directory/
speciesConfigPath=src/main/resources/Species.json
stepsToRunConfigPath=src/main/resources/stepsToRun.config
```
<b> Running the program </b>

Now that the Pathway-Exchange project is accessible and the `config.properties` file set, the step can be run using the script runner <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/runDownloadDirectory.sh">runDownloadDirectory.sh</a>.

<b>Note</b>: The <b>ReactomeBook</b> and <b>CreateReleaseTarball</b> steps still use the old Perl scripts found <a href="https://github.com/reactome/Release/tree/master/scripts/release/download_directory">here</a>. This means that, to generate the their output files, Download Directory will need to be run in either a docker container with the <a href="https://github.com/reactome/Release">Release</a> project usable (see <a href="https://github.com/reactome/Release/tree/release-container/container">release-container</a> project), or on the release server. Download Directory can be run anywhere despite this, but if these steps aren't commented out in <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/src/main/resources/stepsToRun.config">stepsToRun.config</a> (see below), they will report errors.
<br>

If the DownloadDirectory step has been run from the <a href="https://github.com/reactome/Release/blob/master/scripts/release/release.pl">release.pl</a> wrapper on the release server, the generated files would appear in `/usr/local/reactomes/Reactome/production/Website/static/download/67/` (if it was release 67). When the jar file is run directly, the files will appear in `/usr/local/gkb/scripts/release/download_directory/67/`. 

<b> Running specific modules of Download Directory </b>

Specific files can be generated via the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/src/main/resources/stepsToRun.config">stepsToRun.config</a> file found in the `src/main/resources/` folder. This file contains a list of all steps that will be run during the Download Directory process.
Commenting out steps in this file will cause it to be excluded during the run. Sample below:
```
# This file is used to specify which steps in DownloadDirectory to execute.
# Comment out any steps that don't need to be run.
DatabaseDumps
#BioPAX2
BioPAX3
GSEAOutput
FetchTestReactomeOntologyFiles
#PathwaySummationMappingFile
MapOldStableIds
gene_association.reactome
models2pathways.tsv
CreateReactome2BioSystems
```
In this example, the BioPAX2 and PathwaySummationMappingFile steps will not be run. 

<b> Running specific modules in Jenkins </b>

When running Download Directory in Jenkins, the code is cloned from Github each time so updating the stepsToRun file locally is not possible. Instead, you will need to upload the modified stepsToRun file as a Jenkins 'credential' before re-running download directory. This is explained step-by-step below:

  1) Modify the `stepsToRun.config` file found in `src/main/resources` folder so that only the step(s) you want to run are not commented out. 
  2) In Jenkins, navigate to Releases -> releaseNumber (eg: 70). 
  3) On the left-hand side, select Credentials. You should see a table of different credentials used by Jenkins. Look for the one with the ID 'stepsToRun' and select 'stepsToRun.config' uner the Name column.
  4) On the left-hand side of this page, click Update, and then click the check-box for 'Upload stepsToRun.config' again.
  5) Upload the stepsToRun file you modified in step 1. Save and re-run Download Directory -- only the steps you specified will be run.

<h3> Verifying Download Directory Results</h3>

This section will touch on the <b>files</b> produced by each step in Download Directory, and how to verify they were produced correctly. Often, comparing the files produced in the previous release is the way to go, but where needed this guide will provide additional suggestions for checking the output.

<b>Note</b>: During Download Directory, the output files are temporarily held in a folder corresponding to the current release. For release 67, the output files would appear in `data-release-pipeline/downloadDirectory/67/`. 

<h4>DatabaseDumps</h4>

This step generates two mySQL dump files from the `stable_identifiers` and `test_reactome` databases. The files produced are `gk_stable_ids.sql.gz` and `gk_current.sql.gz`, respectively. These are then placed in the `data-release-pipeline/downloadDirectory/67/databases/` folder (if it was release 67). Comparing the size of these files to the previous release is sufficient for verifying the success of this step. 

<h4>BioPAX</h4>

This step generates <b>BioPAX level 2</b> and <b>level 3</b> files for each species in the `test_reactome` database. Additional information on BioPAX can be found at its <a href="http://www.biopax.org/">website</a>. This will typically be the longest running step of Download Directory, particularly due to the generation of the level 3 BioPAX files. It makes use of the Pathway-Exchange jar that should have been locally installed during the <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#-preparing-and-running-download-directory">preparation</a> step of Download Directory.

<b>Note</b>: Due to the dependency on a local installation of Pathway-Exchange, this is also the most error-prone step of Download Directory. Any <i>attribute</i> or <i>instance</i> errors that result from BioPAX might mean that this installation will need to be updated to the most recent <a href="https://github.com/reactome/Pathway-Exchange/blob/master/ant/PathwayExchangeJar.xml">version</a>. See above for instructions on installing/updating the Pathway-Exchange module. 

Each zip file produced should contain a number of files (`owl` or validation `xml`) corresponding to the species found in the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/src/main/resources/Species.json">Species.json</a> file.

`biopax2.zip`: This zip file should contain BioPAX <b>level 2</b> files for each species in `Species.json`. Inspect a few of the files for the string `biopax-level2` near the beginning. Next, look at the corresponding validation files (found in `biopax2_validator.zip`) (see below).

`biopax.zip`: This zip file should contain BioPAX <b>level 3</b> files for each species in `Species.json`. Inspect a few of the files for the string `biopax-level3` near the beginning. Next, look at the corresponding validation files (found in `biopax_validator.zip`) (see below).

`biopax2_validator.zip` & `biopax_validator.zip`:  These zip files should contain a `validation.xml` file for each species that has an `owl` file. These validation files can be quite large since they report problems at both the <b>warning</b> and <b>error</b> levels, and typically there have been many warnings. Checking the `<validation description>` tag in the validation file will list the number of problems found, including any errors that might have come up. <b>Any errors found will need to be investigated</b>. Additionally, comparing the number of warnings between releases is another way to ensure that the BioPAX process ran successfully.

Finally, a BioPAX validator tool exists <a href="http://biopax.baderlab.org/">online</a>. The `owl` files can be run through here as well to check file validity.

<h4>GSEAOutput</h4>

This step uses the <a href="https://github.com/reactome/Pathway-Exchange/blob/master/src/org/reactome/gsea/ReactomeToMsigDBExport.java">ReactomeToMsigDBExport</a> method found in Pathway-Exchange. Ensure that the jar has been installed locally, as described in an earlier <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#-preparing-and-running-download-directory">section</a> of this document. It takes all <b>Human</b> Pathway instances in the `test_reactome` database and converts the data to <i>MSigDB</i> format, which can be used in <i>Gene Set Enrichment Analysis</i> (GSEA). More information can be found at the GSEA <a href="http://software.broadinstitute.org/gsea/msigdb">website</a>. 

The `Reactome.gmt.zip` file produced is tab-seperated, with each row having varying numbers of columns. The first few columns for each row are a Pathway instance's <i>displayName</i> and <i>stableIdentifier</i> values, and the string `Reactome Pathway`. This third column is added manually after initially generating the `Reactome.gmt` file. The remaining columns are all gene names that are associated with the Pathway instance (needs confirmation). The <b>GSEAOutput</b> step attempts to add a line for each Human Pathway, but some entries are excluded due to missing attributes in the instance, meaning that the file should have nearly as many lines as there are Human Pathway instances in `test_reactome`. 

<h4>FetchTestReactomeOntologyFiles</h4>

This step produces 3 different files, `reactome_data_model.pprj`, `reactome_data_model.pont`, and `reactome_data_model.pins`. All are parsed from the <i>ontology</i> attribute in the <i>Ontology</i> table in `test_reactome`. This value in Ontology.ontology is a <b>blob</b> that contains all 3 files. The contents of each file are parsed out of the blob during the <b>FetchTestReactomeOntologyFiles</b> step. These files are associated with <i>Protégé 2.0</i> (<a href="https://protege.stanford.edu/">website</a>)and can be used with their software. Additional information about each filetype can be found <a href="https://protegewiki.stanford.edu/wiki/PrF_UG_files_protege_files">here</a>.

Compare each file with its equivalent from the previous release. The beginning and end of each file should have the same formatting between them, although the content may differ. 

<h4>PathwaySummationMappingFile</h4>
 
This step creates a tab-seperated file, `pathway2summation.txt`. The file contains information on all Human Pathways in `test_reactome`. The 3 columns of the file are <i>stableIdentifier</i>, <i>name</i>, and <i>summation</i>. The file is populated from all <b>Human</b> Pathway instances. 

The file should have the same amount of lines as Human Pathway instances in `test_reactome`. 

<h4>MapOldStableIds</h4>

This step will match old <b>stableIdentifiers</b> to ones in the new format. The file contains two tab-seperated columns of stable IDs in the new (eg: `R-HSA-1234567`) and old (eg: `REACT_98765`) formats. The file should include stableIdentifiers for <b>all species</b> in Reactome, and should have approximately the same number of lines as <i>stableIdentifier</i> instances in `test_reactome`.

<h4>GenerateGOAnnotationFile</h4>

This step generates the 'gene_association.reactome' GO Annotation file. Information about the file format can be found <a href="https://www.ebi.ac.uk/GOA/newto">here</a>. This step will go through all <b>curated</b> ReactionlikeEvents that are in the database and generate GOA lines for a variety of instances pertaining to all 3 of the Gene Ontology annotation types: <b>Cellular Compartment</b>, <b>Molecular Function</b> and <b>Biological Process</b>.


Further information on the details of the GenerateGOAnnotationFile step can be found <a href="https://github.com/reactome/data-release-pipeline/blob/feature/goa-prepare/downloadDirectory/src/main/java/org/reactome/release/downloadDirectory/GenerateGOAnnotationFile/README.md">here</a>.

To check the file, compare it with previous release. Since the number of curated proteins does not change drastically between release, there should be a relatively similar amount of annotations in the files.

<h4>models2pathways.tsv</h4>

This step copies the `models2pathways.tsv` file that is produced during the <a href="https://github.com/reactome/Release/tree/master/scripts/release/biomodels">Biomodels</a> step. Comparing the file to previous releases is sufficient for this step.

<h4>Protege exporter</h4>
This step will run the protege export code in `GKB::WebUtils`. The Perl code will create an archive file containing a pins, pont, and pprj file, for a given pathway. This code is designed to only export TOP-LEVEL pathways, as defined as pathways associated with the FrontPageItem in the database.

This step takes the following configuration options, specified in `config.properties`:
 - protegeexporter.pathToWrapperScript - This is the _absolute_ path to the directory containing the Perl wrapper script `run_protege_exporter.pl`. The script should be located in `src/main/resources` for _this_ project.
 - protegeexporter.parallelism - The number of concurrent protege export jobs to run. Try to keep this smaller than the number of available cores (MySQL and your operating system should get 1 core each, at least). If you do not specify anything for this value, then parallelism will be the default value used by the `ForkJoinPool` class, which is usually the number of cores minus 1.
 - protegeexporter.extraIncludes - If you need to specify additional include paths for Perl, use this option. this should be a comma-separate string formatted as: `-I/alt/path/to/perl/libs,-I/other/alt/path/to/libs`.
 - protegeexporter.filterIds - If you want to filter to only export specific pathways, specify them here as a comma-separated list of DB_IDs.
 - protegeexporter.filterSpecies - If you want to filter to only export pathways of a specific species, you can specify a comma-separated list here. Normally, you would just set this to `Homo sapiens`.

<h4>CreateReactome2BioSystems</h4>

This step creates a zip file containing an <i>NCBI BioSystems</i>-formatted `xml` file for each of Reactome's <b>primary model organisms</b>. More information on NCBI BioSystems is found at the <a href="https://www.ncbi.nlm.nih.gov/biosystems/">website</a>.

This module uses the <a href="https://github.com/reactome/Pathway-Exchange/blob/master/src/org/gk/biosystems/ReactomeToBioSystemsConverter.java">ReactomeToBioSystemsConverter</a> method in Pathway-Exchange. Ensure that the jar has been installed locally, as described in an earlier <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#-preparing-and-running-download-directory">section</a> of this document. 

Compare the files produced with those from an earlier release for verification the process ran successfully. 







